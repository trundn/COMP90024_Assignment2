---
# Remove harvesters in Database Instances
- name: Remove Harvest containers
  become: yes
  docker_container:
    name: "{{ harvester_instance1 }}"
    state: absent
    
# Copy Directories to Database Instances
- name: Copy harvest and script folder
  become: yes
  synchronize:
    src: "../../../{{ item }}"
    dest: /home/ubuntu/app
    mode: push
    rsync_opts:
      - "--exclude=dataset"
  with_items:
    - harvest
    - script

# Copy Dockerfile to Database Instances
- name: Copy Dockerfile.harvest.stream
  become: yes
  copy:
    src: ../../templates/Dockerfile.harvest.stream
    dest: /home/ubuntu

# Create stream harvester 
- name: Build stream harvester image
  become: yes
  docker_image:
    name: "{{ harvester_instance1 }}"
    build: 
      dockerfile: "{{ dockerfile_stream }}"
      path: /home/ubuntu
      pull: yes
    state: present
    source: build
    force_source: yes
    
- name: Run stream harvester container
  become: yes
  docker_container:
    name: "{{ harvester_instance1 }}"
    volumes:
      - "/data/app:/opt/app"
    image: "{{ harvester_instance1 }}"
    detach: yes
    state: started
    